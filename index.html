<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <meta name="color-scheme" content="light dark">
  <title>БелАЗ</title>
  <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/truck.png">

  <style>
    :root{
      /* iOS-like palette */
      --bg: #f2f2f7;
      --text: #111111;
      --subtext: rgba(60,60,67,.6);
      --separator: rgba(60,60,67,.28);

      --blue: #007aff;
      --green: #34c759;
      --red: #ff3b30;
      --orange: #ff9f0a;
      --purple: #af52de;

      /* Glass */
      --glassBarLight: rgba(242,242,247,.72);
      --glassCardLight: rgba(255,255,255,.72);

      --radius: 18px;
      --radiusSmall: 14px;

      /* Bar */
      --barBg: rgba(120,120,128,.16);
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg: #000000;
        --text: #ffffff;
        --subtext: rgba(235,235,245,.6);
        --separator: rgba(84,84,88,.55);

        --glassBarLight: rgba(28,28,30,.62);
        --glassCardLight: rgba(28,28,30,.62);

        --barBg: rgba(120,120,128,.24);
      }
    }

    *{ margin:0; padding:0; box-sizing:border-box; }

    html, body{
      height:100%;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overscroll-behavior: none;
    }

    /* ===== Background (keeps your bag.WEBP, adds iOS-like glow for glass visibility) ===== */
    body{
      background:
        radial-gradient(900px 520px at 18% 0%, rgba(0,122,255,.18), transparent 60%),
        radial-gradient(760px 520px at 88% 12%, rgba(52,199,89,.14), transparent 58%),
        radial-gradient(820px 560px at 40% 100%, rgba(255,159,10,.12), transparent 58%),
        url('bag.WEBP') no-repeat center center fixed;
      background-size: cover;
      padding-bottom: 120px; /* space for FAB */
    }

    .overlay{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(6px) saturate(130%);
      -webkit-backdrop-filter: blur(6px) saturate(130%);
    }

    .container{
      max-width: 520px;
      margin: 0 auto;
      padding:
        calc(env(safe-area-inset-top, 0) + 8px)
        0
        calc(env(safe-area-inset-bottom, 0) + 8px)
        0;
    }

    /* ===== Top glass bar (like iOS) ===== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      margin: 0 0 10px;

      padding: 10px 16px 12px;
      backdrop-filter: saturate(180%) blur(22px);
      -webkit-backdrop-filter: saturate(180%) blur(22px);
      background: var(--glassBarLight);
      border-bottom: 0.5px solid var(--separator);
    }

    .topbar-row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
    }

    .title{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.1;
    }

    .subtitle{
      margin-top: 6px;
      font-size: 13px;
      color: var(--subtext);
    }

    /* ===== Glass card base ===== */
    .glass{
      background: var(--glassCardLight);
      backdrop-filter: blur(18px) saturate(140%);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
      border: 0.5px solid rgba(60,60,67,.16);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow:
        0 1px 0 rgba(0,0,0,.05),
        0 10px 30px rgba(0,0,0,.10);
    }
    @media (prefers-color-scheme: dark){
      .glass{
        border-color: rgba(84,84,88,.45);
        box-shadow:
          0 1px 0 rgba(0,0,0,.12),
          0 12px 34px rgba(0,0,0,.35);
      }
    }

    .section{
      margin: 0 14px 12px;
    }

    /* ===== Plan row ===== */
    .plan{
      padding: 12px 14px;
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .plan-left{
      display:flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .plan-label{
      font-size: 13px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: var(--subtext);
      white-space: nowrap;
    }

    .plan-hint{
      font-size: 12px;
      color: var(--subtext);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 260px;
    }

    .plan input{
      width: 160px;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text);
      font-size: 34px;
      font-weight: 900;
      text-align: right;
      letter-spacing: -0.02em;
    }

    /* ===== Progress bar ===== */
    .bar-container{
      height: 14px;
      margin: 10px 10px 12px;
      border-radius: 999px;
      overflow: hidden;
      background: var(--barBg);
      border: 0.5px solid rgba(60,60,67,.14);
    }
    .bar{
      height: 100%;
      width: 0%;
      transition: 0.7s ease;
      border-radius: 999px;
    }

    /* ===== Stats ===== */
    .stats{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      padding: 0 14px 14px;
    }

    .stat{
      display:flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat .k{
      font-size: 13px;
      color: var(--subtext);
    }
    .stat .v{
      font-size: 32px;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1.05;
    }

    /* ===== Cards list ===== */
    .cards{ padding: 0 8px; }

    .card{
      position: relative;
      margin: 0 6px 12px;
      padding: 10px 14px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      border-radius: var(--radius);
    }

    .card-capacity-corner{
      position:absolute;
      top: 8px;
      right: 10px;
      font-size: 12px;
      color: var(--subtext);
      opacity: .9;
    }

    /* checkbox — iOS-like */
    .card-checkbox{
      appearance:none;
      -webkit-appearance:none;
      position:absolute;
      left: 10px;
      top: 10px;
      width: 22px;
      height: 22px;
      border-radius: 7px;
      background: rgba(120,120,128,.16);
      border: 0.5px solid rgba(60,60,67,.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: inset 0 0 6px rgba(255,255,255,.20);
      transition: all .2s ease;
    }
    .card-checkbox:checked{
      background: linear-gradient(135deg, #0a84ff, #007aff);
      border-color: rgba(255,255,255,.5);
      box-shadow: 0 0 10px rgba(10,132,255,.5), inset 0 0 6px rgba(255,255,255,.25);
    }
    .card-checkbox:checked::after{
      content:'✓';
      position:absolute;
      left: 5px;
      top: 0px;
      color:#fff;
      font-weight: 900;
      font-size: 16px;
      text-shadow: 0 0 6px rgba(255,255,255,.6);
    }

    .card-center{
      flex:1;
      min-width: 0;
      height: 86px;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .card-title{
      font-size: 26px;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1;
      margin-top: -14px; /* keep your positioning vibe */
    }

    .card-trips{
      font-size: 52px;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1;
      margin-top: -6px;
    }

    /* ===== iOS-ish round buttons (+ / -) closer to Telegram-like pill softness ===== */
    .btn{
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border: 0.5px solid rgba(60,60,67,.16);
      background: rgba(120,120,128,.14);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 34px;
      font-weight: 900;
      color: var(--text);
      box-shadow:
        inset 0 0 10px rgba(255,255,255,.14),
        0 10px 22px rgba(0,0,0,.12);
      transition: transform .08s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
    }
    .btn:active{ transform: scale(.96); filter: brightness(.96); }

    .btn.plus{
      border-color: rgba(52,199,89,.22);
      background: rgba(52,199,89,.16);
    }
    .btn.minus{
      border-color: rgba(255,59,48,.22);
      background: rgba(255,59,48,.14);
    }

    .btn.disabled{
      opacity:.30;
      pointer-events:none;
      filter: grayscale(1);
    }

    /* ===== FAB (center bottom, iOS sheet trigger style) ===== */
    .fab{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom, 0) + 14px);
      width: 72px;
      height: 72px;
      border-radius: 999px;
      border: 0;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;

      background: linear-gradient(135deg,#0a84ff,#007aff);
      color: #fff;
      font-size: 40px;
      font-weight: 900;
      box-shadow: 0 16px 40px rgba(10,132,255,.55);
      transition: transform .08s ease, filter .12s ease;
      z-index: 30;
    }
    .fab:active{ transform: translateX(-50%) scale(.97); filter: brightness(.96); }

    /* ===== Bottom sheet menu (more iOS-like) ===== */
    .scrim{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.22);
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s ease;
      z-index: 40;
    }
    .scrim.open{
      opacity: 1;
      pointer-events: auto;
    }

    .menu{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      z-index: 50;

      padding: 14px 14px calc(env(safe-area-inset-bottom, 0) + 14px);
      border-radius: 26px 26px 0 0;

      transform: translateY(105%);
      transition: transform .28s ease;

      backdrop-filter: saturate(180%) blur(24px);
      -webkit-backdrop-filter: saturate(180%) blur(24px);
      background: var(--glassBarLight);
      border-top: 0.5px solid var(--separator);
      box-shadow: 0 -18px 50px rgba(0,0,0,.25);
    }
    .menu.open{ transform: translateY(0); }

    .grabber{
      width: 44px;
      height: 5px;
      border-radius: 999px;
      margin: 4px auto 12px;
      background: rgba(120,120,128,.35);
    }

    .menu button{
      width: 100%;
      padding: 16px 14px;
      border-radius: 16px;
      border: 0.5px solid rgba(60,60,67,.16);
      background: rgba(255,255,255,.10);
      color: var(--text);
      font-size: 17px;
      font-weight: 700;
      letter-spacing: -0.01em;
      margin: 10px 0;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, filter .12s ease;
    }
    .menu button:active{ transform: scale(.99); filter: brightness(.96); }

    .menu .add{ border-color: rgba(10,132,255,.25); background: rgba(10,132,255,.12); }
    .menu .send{ border-color: rgba(48,209,88,.25); background: rgba(48,209,88,.12); }
    .menu .reset{ border-color: rgba(255,59,48,.25); background: rgba(255,59,48,.10); }
    .menu .close{ background: rgba(120,120,128,.14); }

    /* Make excluded card look like “muted” */
    .muted{
      opacity: .40;
      filter: grayscale(.2);
    }
  </style>
</head>

<body>
  <div class="overlay"></div>

  <div class="topbar">
    <div class="container">
      <div class="topbar-row">
     
      </div>
    </div>
  </div>

  <div class="container">

    <div class="section glass plan">
      <div class="plan-left">
        <div class="plan-label">План</div>
        <div class="plan-hint">Введите цель на смену</div>
      </div>
      <input type="number" id="plan" value="3000" inputmode="numeric">
    </div>

    <div class="section glass">
      <div class="bar-container"><div class="bar" id="bar"></div></div>

      <div class="stats">
        <div class="stat">
          <div class="k">Сделано</div>
          <div class="v" id="done">0.0</div>
        </div>
        <div class="stat" style="text-align:right">
          <div class="k">Осталось / +</div>
          <div class="v" id="left">3000.0</div>
        </div>
      </div>
    </div>

    <div class="cards" id="cards"></div>
  </div>

  <button class="fab" id="fab" aria-label="Меню">+</button>

  <div class="scrim" id="scrim" onclick="closeMenu()"></div>

  <div class="menu" id="menu" role="dialog" aria-modal="true" aria-label="Меню">
    <div class="grabber" aria-hidden="true"></div>
    <button class="add" onclick="addBelaz()">Добавить БелАЗ</button>
    <button class="send" onclick="sendReport()">Отправить диспетчеру</button>
    <button class="reset" onclick="resetShift()">Сбросить смену</button>
    <button class="close" onclick="closeMenu()">Закрыть</button>
  </div>

  <script>
    const capacities=[37.8,36,21];

    let belazList = JSON.parse(localStorage.getItem('belazList')||'[]')
      .map((b,i)=>({...b, originalIndex: b.originalIndex ?? i}));

    let plan = parseFloat(localStorage.getItem('plan')||'3000');
    document.getElementById('plan').value = plan;

    function save(){
      localStorage.setItem('belazList', JSON.stringify(belazList));
      localStorage.setItem('plan', plan);
    }

    function calc(){
      const total = belazList.reduce((s,b)=>s + b.trips*b.capacity, 0);
      const percent = total / plan;
      const over = Math.max(0, total - plan);

      document.getElementById('done').textContent = total.toFixed(1);

      const leftEl = document.getElementById('left');
      leftEl.textContent = over>0 ? `+${over.toFixed(1)}` : (plan-total).toFixed(1);
      leftEl.style.color = over>0 ? 'var(--purple)' : 'var(--orange)';

      const bar = document.getElementById('bar');
      bar.style.width = Math.min(percent*100, 200) + '%';

      // iOS-like color steps
      if(percent < 0.7) bar.style.background = 'var(--red)';
      else if(percent < 1) bar.style.background = 'var(--orange)';
      else bar.style.background = 'var(--green)';
    }

    function renderCards(){
      const c = document.getElementById('cards');
      c.innerHTML = '';

      belazList.forEach((b,i)=>{
        const card = document.createElement('div');
        card.className = 'card glass' + (b.exclude ? ' muted' : '');

        card.innerHTML = `
          <button class="btn minus ${b.exclude?'disabled':''}" onclick="changeTrip(${i},-1)">−</button>

          <div class="card-center">
            <div class="card-title">${escapeHtml(String(b.number))}</div>
            <div class="card-trips">${b.trips}</div>
          </div>

          <button class="btn plus ${b.exclude?'disabled':''}" onclick="changeTrip(${i},1)">+</button>

          <input type="checkbox" class="card-checkbox" ${b.exclude?'checked':''} onchange="toggleExclude(${i})" aria-label="Исключить">
          <div class="card-capacity-corner">${b.capacity}</div>
        `;

        c.appendChild(card);
      });

      calc();
    }

    function changeTrip(i,d){
      if(belazList[i].trips + d >= 0){
        belazList[i].trips += d;
        save(); renderCards();
      }
    }

    function toggleExclude(i){
      const b = belazList[i];
      b.exclude = !b.exclude;

      const it = belazList.splice(i,1)[0];

      if(it.exclude) belazList.push(it);
      else{
        const pos = belazList.findIndex(e=>e.originalIndex > it.originalIndex);
        belazList.splice(pos===-1 ? belazList.length : pos, 0, it);
      }

      save(); renderCards();
    }

    function addBelaz(){
      const num = prompt("Номер БелАЗа:");
      if(!num) return;

      const sel = prompt("Кубатура:\n1) 37.8\n2) 36.0\n3) 22.0","1");
      const cap = capacities[parseInt(sel)-1] || 37.8;

      belazList.push({
        number: num.trim(),
        capacity: cap,
        trips: 0,
        exclude: false,
        originalIndex: belazList.length
      });

      save(); renderCards(); closeMenu();
    }

    function sendReport(){
      const active = belazList.filter(b=>!b.exclude && b.trips>0);
      let text = active.map(b=>`${b.number} - ${b.trips}`).join("\n");
      if(!text) text = "-";
      location.href = "https://wa.me/79617080028?text=" + encodeURIComponent(text);
    }

    function resetShift(){
      if(confirm("Сбросить смену?")){
        belazList = [];
        plan = 3000;
        localStorage.clear();
        document.getElementById('plan').value = plan;
        renderCards(); closeMenu();
      }
    }

    // Bottom sheet open/close
    const menu = document.getElementById('menu');
    const scrim = document.getElementById('scrim');

    document.getElementById('fab').onclick = () => {
      menu.classList.add('open');
      scrim.classList.add('open');
    };

    function closeMenu(){
      menu.classList.remove('open');
      scrim.classList.remove('open');
    }

    // Plan input
    document.getElementById('plan').oninput = e => {
      plan = Math.max(parseFloat(e.target.value) || 3000, 1);
      save(); calc();
    };

    // Small helper to avoid HTML injection in number field
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    renderCards();
  </script>
</body>
</html>