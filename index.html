<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ò–ò, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ç—ã –æ–±—É—á–∞–µ—à—å</title>
  <style>
    :root { font-family: -apple-system, system-ui, Arial; }
    body { margin:0; background:#0b0d12; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    h1 { margin: 8px 0 6px; font-size: 22px; }
    .sub { margin: 0 0 12px; opacity:.8; line-height: 1.35; }
    .card { background:#111626; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 820px) { .grid { grid-template-columns: 1fr; } }

    .chat {
      height: 52vh;
      overflow: auto;
      padding: 10px;
      background: #0a0f1c;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .msg { max-width: 85%; padding: 10px 12px; border-radius: 14px; margin: 8px 0; white-space: pre-wrap; }
    .me { background:#2a6bff; margin-left:auto; }
    .ai { background:#1c2238; }
    .meta { font-size: 12px; opacity: .8; margin-top: 4px; }

    input, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: #0a0f1c;
      color: #e9eefc;
      outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }

    button {
      border: 0;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 800;
      background: #2a6bff;
      color: #fff;
    }
    button.ghost { background: transparent; border: 1px solid rgba(255,255,255,.18); }
    button:disabled { opacity: .45; }

    .progressBox { margin: 10px 0 14px; }
    .bar { height: 10px; background: rgba(255,255,255,.12); border-radius: 999px; overflow:hidden; }
    .bar > div { height: 100%; width: 0%; background: #2a6bff; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; opacity:.9; }
    .pill { display:inline-block; padding:6px 10px; border:1px solid rgba(255,255,255,.15); border-radius:999px; }
    details { margin-top: 8px; opacity: .9; }
    summary { cursor: pointer; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>–ò–ò, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ç—ã –æ–±—É—á–∞–µ—à—å</h1>
    <p class="sub">
      –¢—ã —É—á–∏—à—å: <b>‚Äú—á—Ç–æ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å‚Äù ‚Üí ‚Äú–∫–∞–∫ –æ–Ω –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å‚Äù</b>.
      –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ –≤ —á–∞—Ç–µ, –∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–Ω —Å—Ç–∞–ª —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –∏ —Ç–æ—á–Ω–µ–µ.
    </p>

    <section class="card">
      <div class="progressBox">
        <div class="row" style="justify-content: space-between;">
          <div>–£—Ä–æ–≤–µ–Ω—å ‚Äú–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞‚Äù: <b id="lvl">0%</b></div>
          <div class="mono" id="status">–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶</div>
        </div>
        <div class="bar"><div id="bar"></div></div>
        <div class="row">
          <span class="pill mono">–ü—Ä–∏–º–µ—Ä–æ–≤: <b id="n">0</b></span>
          <span class="pill mono">–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞: <b id="acc">‚Äî</b></span>
          <span class="pill mono">–ü–æ—Ä–æ–≥ –æ—Ç–≤–µ—Ç–∞: <b id="thrLabel">0.45</b></span>
          <button id="btnRecalc" class="ghost">üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          <button id="btnWipe" class="ghost">üß® –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="mono" style="margin-bottom:8px;">–ß–∞—Ç</div>
          <div class="chat" id="chat"></div>

          <div class="row">
            <input id="msg" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" />
            <button id="send">‚ñ∂</button>
          </div>

          <div class="row">
            <button id="btnRight" disabled>üëç –ø—Ä–∞–≤–∏–ª—å–Ω–æ</button>
            <button id="btnWrong" class="ghost" disabled>üëé –∏—Å–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>

          <div class="mono" id="lastInfo">‚Äî</div>
        </div>

        <div>
          <div class="mono" style="margin-bottom:8px;">–ù–∞—É—á–∏—Ç—å (–≤–æ–ø—Ä–æ—Å ‚Üí –æ—Ç–≤–µ—Ç)</div>
          <div class="row">
            <textarea id="teachQ" placeholder="–ß—Ç–æ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å (–ø—Ä–∏–º–µ—Ä):&#10;‚Äú–°–¥–µ–ª–∞–π —á–µ—Å—Ç–Ω–æ –∏ –∫–æ—Ä–æ—Ç–∫–æ‚Äù&#10;‚Äú–ï—Å–ª–∏ —è –ø–∏—à—É ‚Äò–∂—ë—Å—Ç–∫–æ‚Äô ‚Äî –Ω–µ —Å–º—è–≥—á–∞–π‚Äù"></textarea>
          </div>
          <div class="row">
            <textarea id="teachA" placeholder="–ö–∞–∫ –ò–ò –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å"></textarea>
          </div>
          <div class="row">
            <button id="btnTeach" disabled>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏ –æ–±—É—á–∏—Ç—å</button>
            <button id="btnExport" class="ghost">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="btnImport" class="ghost">üì• –ò–º–ø–æ—Ä—Ç</button>
          </div>

          <details>
            <summary>–ö–∞–∫ —ç—Ç–æ ‚Äú—É—á–∏—Ç—Å—è‚Äù</summary>
            <ul>
              <li>–ò–ò –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–≤–æ—é —Ñ—Ä–∞–∑—É –≤ ‚Äú—Å–º—ã—Å–ª–æ–≤–æ–π –≤–µ–∫—Ç–æ—Ä‚Äù.</li>
              <li>–ò—â–µ—Ç —Å–∞–º—ã–π –ø–æ—Ö–æ–∂–∏–π –≤–æ–ø—Ä–æ—Å –∏–∑ —Ç–æ–≥–æ, —á–µ–º—É —Ç—ã –µ–≥–æ —É—á–∏–ª.</li>
              <li>–ï—Å–ª–∏ –ø–æ—Ö–æ–∂–µ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è ‚Äî –æ—Ç–≤–µ—á–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ—Ç–≤–µ—Ç–æ–º.</li>
              <li>–ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞—Å—Ç—ë—Ç, –∫–æ–≥–¥–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –±–æ–ª—å—à–µ –∏ —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—à–µ.</li>
            </ul>
          </details>

          <details>
            <summary>–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –æ–Ω –æ—Ç–≤–µ—á–∞–µ—Ç ‚Äú–Ω–µ –∑–Ω–∞—é‚Äù</summary>
            <ul>
              <li>–ù–∞–∂–º–∏ <b>‚Äúüëé –∏—Å–ø—Ä–∞–≤–∏—Ç—å‚Äù</b> –∏ –¥–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî —ç—Ç–æ –±—É–¥–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä.</li>
              <li>–ò–ª–∏ –¥–æ–±–∞–≤—å –ø—Ä–∞–≤–∏–ª–æ/–ø—Ä–∏–º–µ—Ä –≤ –±–ª–æ–∫–µ ‚Äú–ù–∞—É—á–∏—Ç—å‚Äù.</li>
            </ul>
          </details>

          <div class="row">
            <label class="mono">–ü–æ—Ä–æ–≥ –ø–æ—Ö–æ–∂–µ—Å—Ç–∏:
              <input id="thr" type="range" min="0.20" max="0.80" step="0.01" value="0.45" />
            </label>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- TFJS + Universal Sentence Encoder -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3"></script>

  <script>
    // ================== state ==================
    const LS_KEY = "personal_ai_pairs_v1";

    let useModel = null;
    let pairs = [];        // {q: string, a: string}
    let qEmb = [];         // Float32Array embeddings for q

    let lastUserText = "";
    let lastAiText = "";
    let lastMatch = { idx: -1, sim: 0 };

    // ================== ui ==================
    const $ = (id) => document.getElementById(id);

    const chat = $("chat");
    const msg = $("msg");
    const send = $("send");

    const btnRight = $("btnRight");
    const btnWrong = $("btnWrong");

    const teachQ = $("teachQ");
    const teachA = $("teachA");
    const btnTeach = $("btnTeach");

    const lvl = $("lvl");
    const bar = $("bar");
    const status = $("status");
    const nEl = $("n");
    const accEl = $("acc");
    const lastInfo = $("lastInfo");

    const btnRecalc = $("btnRecalc");
    const btnWipe = $("btnWipe");

    const btnExport = $("btnExport");
    const btnImport = $("btnImport");

    const thr = $("thr");
    const thrLabel = $("thrLabel");

    function setStatus(s){ status.textContent = s; }

    function addMsg(text, who, meta){
      const div = document.createElement("div");
      div.className = "msg " + (who === "me" ? "me" : "ai");
      div.textContent = text;
      chat.appendChild(div);

      if (meta){
        const m = document.createElement("div");
        m.className = "meta";
        m.textContent = meta;
        chat.appendChild(m);
      }

      chat.scrollTop = chat.scrollHeight;
    }

    // ================== utils ==================
    function savePairs(){
      localStorage.setItem(LS_KEY, JSON.stringify(pairs));
    }

    function loadPairs(){
      try {
        pairs = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
        if (!Array.isArray(pairs)) pairs = [];
      } catch {
        pairs = [];
      }
    }

    async function embedOne(text){
      // returns Float32Array
      const t = await useModel.embed([text]);
      const arr = await t.array();
      t.dispose();
      return new Float32Array(arr[0]);
    }

    function cosine(a, b){
      let dot = 0, na = 0, nb = 0;
      for (let i=0;i<a.length;i++){
        const x = a[i], y = b[i];
        dot += x*y;
        na += x*x;
        nb += y*y;
      }
      return dot / (Math.sqrt(na)*Math.sqrt(nb) + 1e-8);
    }

    async function rebuildEmbeddings(){
      qEmb = [];
      for (let i=0;i<pairs.length;i++){
        qEmb.push(await embedOne(pairs[i].q));
      }
    }

    // nearest neighbor retrieval
    function retrieve(queryEmb, excludeIdx = -1){
      let bestIdx = -1;
      let bestSim = -1;
      for (let i=0;i<qEmb.length;i++){
        if (i === excludeIdx) continue;
        const s = cosine(queryEmb, qEmb[i]);
        if (s > bestSim){
          bestSim = s;
          bestIdx = i;
        }
      }
      return { idx: bestIdx, sim: bestSim };
    }

    function currentThreshold(){
      return Number(thr.value);
    }

    function formatSim(s){
      return (Math.max(0, Math.min(1, s)) * 100).toFixed(1) + "%";
    }

    // ================== "learning" metrics ==================
    async function selfCheckAccuracy(){
      if (pairs.length < 3) return null;

      let correct = 0;
      for (let i=0;i<pairs.length;i++){
        const q = pairs[i].q;
        const trueA = pairs[i].a;

        // embed q
        const qe = await embedOne(q);
        const { idx } = retrieve(qe, i);

        if (idx >= 0 && pairs[idx].a === trueA) correct++;
      }
      return correct / pairs.length;
    }

    function computeLevel(acc){
      // level = mix of accuracy + knowledge volume
      const maxN = 60;
      const knowledge = Math.min(1, pairs.length / maxN);

      const accPart = acc == null ? 0 : acc; // 0..1
      const lvl01 = 0.65*accPart + 0.35*knowledge;
      return Math.round(lvl01 * 100);
    }

    async function updateProgress(){
      nEl.textContent = String(pairs.length);
      thrLabel.textContent = currentThreshold().toFixed(2);

      setStatus("—Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞‚Ä¶");
      let acc = null;
      try {
        acc = await selfCheckAccuracy();
      } catch(e){
        acc = null;
      }

      if (acc == null){
        accEl.textContent = "‚Äî (–º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö)";
      } else {
        accEl.textContent = (acc*100).toFixed(1) + "%";
      }

      const level = computeLevel(acc);
      lvl.textContent = level + "%";
      bar.style.width = level + "%";

      setStatus("–≥–æ—Ç–æ–≤–æ");
    }

    function enableChatFeedback(enabled){
      btnRight.disabled = !enabled;
      btnWrong.disabled = !enabled;
    }

    // ================== core behavior ==================
    async function answerUser(text){
      lastUserText = text;

      if (pairs.length === 0){
        lastAiText = "–Ø –ø–æ–∫–∞ –ø—É—Å—Ç–æ–π. –ù–∞—É—á–∏ –º–µ–Ω—è: —Å–ø—Ä–∞–≤–∞ –¥–æ–±–∞–≤—å –ø—Ä–∏–º–µ—Ä (–≤–æ–ø—Ä–æ—Å ‚Üí –æ—Ç–≤–µ—Ç).";
        lastMatch = { idx:-1, sim:0 };
        return { text: lastAiText, meta: "–Ω–µ—Ç –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π" };
      }

      const qe = await embedOne(text);
      const { idx, sim } = retrieve(qe);

      lastMatch = { idx, sim };

      if (idx < 0 || sim < currentThreshold()){
        lastAiText = "–Ø –Ω–µ —É–≤–µ—Ä–µ–Ω. –ò—Å–ø—Ä–∞–≤—å –º–µ–Ω—è: –Ω–∞–∂–º–∏ ¬´üëé –∏—Å–ø—Ä–∞–≤–∏—Ç—å¬ª –∏ –Ω–∞–ø–∏—à–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî —è –∑–∞–ø–æ–º–Ω—é.";
        return { text: lastAiText, meta: `–ø–æ—Ö–æ–∂–µ—Å—Ç—å: ${formatSim(sim)} (–Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞)` };
      }

      lastAiText = pairs[idx].a;
      return { text: lastAiText, meta: `–∏—Å–ø–æ–ª—å–∑—É—é —É—Ä–æ–∫ #${idx+1}, –ø–æ—Ö–æ–∂–µ—Å—Ç—å: ${formatSim(sim)}` };
    }

    async function teachPair(q, a){
      pairs.push({ q, a });
      savePairs();
      qEmb.push(await embedOne(q));
    }

    // ================== handlers ==================
    send.addEventListener("click", async () => {
      const text = msg.value.trim();
      if (!text) return;
      msg.value = "";

      addMsg(text, "me");
      setStatus("–¥—É–º–∞—é‚Ä¶");
      enableChatFeedback(false);

      try {
        const res = await answerUser(text);
        addMsg(res.text, "ai", res.meta);
        lastInfo.textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–∞—Ç—á: ${lastMatch.idx >= 0 ? ("#"+(lastMatch.idx+1)) : "–Ω–µ—Ç"} | –ø–æ—Ö–æ–∂–µ—Å—Ç—å ${formatSim(lastMatch.sim)}`;
        enableChatFeedback(true);
      } catch(e){
        addMsg("–£ –º–µ–Ω—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", "ai");
        setStatus("–æ—à–∏–±–∫–∞: " + (e?.message || e));
      } finally {
        setStatus("–≥–æ—Ç–æ–≤–æ");
      }
    });

    msg.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send.click();
    });

    btnRight.addEventListener("click", () => {
      // –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –º–æ–∂–Ω–æ –ø–æ–∑–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ "confidence"
      setStatus("–ø—Ä–∏–Ω—è–ª ‚úÖ");
      enableChatFeedback(false);
      setTimeout(()=>setStatus("–≥–æ—Ç–æ–≤–æ"), 300);
    });

    btnWrong.addEventListener("click", async () => {
      const correct = prompt("–ö–∞–∫–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç? (—è –∑–∞–ø–æ–º–Ω—é –∏ –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)");
      if (!correct) return;

      setStatus("—É—á—É—Å—å –Ω–∞ —Ç–≤–æ–µ–π –ø—Ä–∞–≤–∫–µ‚Ä¶");
      enableChatFeedback(false);

      try {
        await teachPair(lastUserText, correct.trim());
        addMsg("–û–∫–µ–π. –Ø –∑–∞–ø–æ–º–Ω–∏–ª —Ç–≤–æ—é –ø—Ä–∞–≤–∫—É –∏ –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å —Ç–∞–∫ –¥–∞–ª—å—à–µ.", "ai", "–¥–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —É—Ä–æ–∫");
        await updateProgress();
      } catch(e){
        setStatus("–æ—à–∏–±–∫–∞ –æ–±—É—á–µ–Ω–∏—è: " + (e?.message || e));
      } finally {
        setStatus("–≥–æ—Ç–æ–≤–æ");
      }
    });

    function updateTeachButton(){
      btnTeach.disabled = !(teachQ.value.trim() && teachA.value.trim() && useModel);
    }
    teachQ.addEventListener("input", updateTeachButton);
    teachA.addEventListener("input", updateTeachButton);

    btnTeach.addEventListener("click", async () => {
      const q = teachQ.value.trim();
      const a = teachA.value.trim();
      if (!q || !a) return;

      setStatus("–¥–æ–±–∞–≤–ª—è—é —É—Ä–æ–∫‚Ä¶");
      btnTeach.disabled = true;

      try {
        await teachPair(q, a);
        teachQ.value = "";
        teachA.value = "";
        addMsg("–Ø –ø–æ–ª—É—á–∏–ª –Ω–æ–≤—ã–π —É—Ä–æ–∫. –ú–æ–∂–µ—à—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ —á–∞—Ç–µ.", "ai", "–æ–±—É—á–µ–Ω–∏–µ: –≤–æ–ø—Ä–æ—Å‚Üí–æ—Ç–≤–µ—Ç");
        await updateProgress();
      } catch(e){
        setStatus("–æ—à–∏–±–∫–∞ –æ–±—É—á–µ–Ω–∏—è: " + (e?.message || e));
      } finally {
        setStatus("–≥–æ—Ç–æ–≤–æ");
        updateTeachButton();
      }
    });

    btnRecalc.addEventListener("click", updateProgress);

    btnWipe.addEventListener("click", async () => {
      if (!confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∑–Ω–∞–Ω–∏—è?")) return;
      pairs = [];
      qEmb = [];
      localStorage.removeItem(LS_KEY);
      addMsg("–Ø –≤—Å—ë –∑–∞–±—ã–ª. –ú–æ–∂–µ—à—å —É—á–∏—Ç—å –º–µ–Ω—è –∑–∞–Ω–æ–≤–æ.", "ai");
      await updateProgress();
    });

    btnExport.addEventListener("click", async () => {
      const payload = JSON.stringify({ pairs }, null, 2);
      // –ø–æ–∫–∞–∂–µ–º –≤ prompt —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
      prompt("–°–∫–æ–ø–∏—Ä—É–π JSON (—ç–∫—Å–ø–æ—Ä—Ç –∑–Ω–∞–Ω–∏–π):", payload);
    });

    btnImport.addEventListener("click", async () => {
      const raw = prompt("–í—Å—Ç–∞–≤—å JSON –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∑–Ω–∞–Ω–∏–π:");
      if (!raw) return;

      try {
        const obj = JSON.parse(raw);
        if (!obj || !Array.isArray(obj.pairs)) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç");
        pairs = obj.pairs.filter(x => x && typeof x.q === "string" && typeof x.a === "string");
        savePairs();
        setStatus("–ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é —ç–º–±–µ–¥–¥–∏–Ω–≥–∏‚Ä¶");
        await rebuildEmbeddings();
        addMsg("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ", "ai");
        await updateProgress();
      } catch(e){
        alert("–ò–º–ø–æ—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è: " + (e?.message || e));
      }
    });

    thr.addEventListener("input", async () => {
      thrLabel.textContent = currentThreshold().toFixed(2);
    });

    // ================== init ==================
    (async () => {
      try {
        loadPairs();
        addMsg("–Ø –≥–æ—Ç–æ–≤. –ù–∞—É—á–∏ –º–µ–Ω—è —Å–ø—Ä–∞–≤–∞ (–≤–æ–ø—Ä–æ—Å‚Üí–æ—Ç–≤–µ—Ç) –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–ª—è–π –º–æ–∏ –æ—Ç–≤–µ—Ç—ã –≤ —á–∞—Ç–µ.", "ai");

        setStatus("–∑–∞–≥—Ä—É–∂–∞—é —è–∑—ã–∫–æ–≤—É—é –º–æ–¥–µ–ª—å‚Ä¶");
        useModel = await use.load(); // Universal Sentence Encoder
        setStatus("—Å—Ç—Ä–æ—é –ø–∞–º—è—Ç—å‚Ä¶");
        await rebuildEmbeddings();

        updateTeachButton();
        await updateProgress();
        setStatus("–≥–æ—Ç–æ–≤–æ");
      } catch(e){
        setStatus("–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + (e?.message || e));
        addMsg("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –æ–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.", "ai");
      }
    })();
  </script>
</body>
</html>
