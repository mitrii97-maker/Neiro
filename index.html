<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–û—Å—Ç–∞–≤–∏—Ç—å / –£–¥–∞–ª–∏—Ç—å ‚Äî –ø–æ —Ñ–æ—Ç–æ</title>
  <style>
    :root { font-family: -apple-system, system-ui, Arial; }
    body { margin: 0; background: #0b0d12; color: #e9eefc; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 18px; }
    h1 { margin: 10px 0 6px; font-size: 26px; }
    .sub { margin: 0 0 14px; opacity: .8; line-height: 1.35; }
    .card { background: #111626; border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 14px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
    button { border: 0; border-radius: 12px; padding: 12px 14px; font-weight: 650; background: #2a6bff; color: white; }
    button:disabled { opacity: .4; }
    button.ghost { background: transparent; border: 1px solid rgba(255,255,255,.18); }
    .preview { position: relative; width: 100%; aspect-ratio: 4/3; background: #0a0f1c; border-radius: 14px; overflow: hidden; border: 1px solid rgba(255,255,255,.08); }
    .preview img { width: 100%; height: 100%; object-fit: contain; display: none; }
    .placeholder { position: absolute; inset: 0; display: grid; place-items: center; opacity: .7; }
    .stats { display: grid; gap: 6px; margin-top: 10px; font-size: 14px; opacity: .9; }
    details { margin-top: 10px; opacity: .9; }
    summary { cursor: pointer; }
    a { color: #8fb2ff; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>–û—Å—Ç–∞–≤–∏—Ç—å / –£–¥–∞–ª–∏—Ç—å</h1>
    <p class="sub">–£—á–∏ –º–æ–¥–µ–ª—å —Å–≤–æ–∏–º –≤–∫—É—Å–æ–º: –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ ‚Üí ¬´–û—Å—Ç–∞–≤–∏—Ç—å/–£–¥–∞–ª–∏—Ç—å¬ª ‚Üí ¬´–û–±—É—á–∏—Ç—å¬ª ‚Üí ¬´–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å¬ª.</p>

    <section class="card">
      <div class="row">
        <input id="file" type="file" accept="image/*" />
        <button id="btnClear" class="ghost" disabled>–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>

      <div class="preview">
        <img id="img" alt="preview" />
        <div id="placeholder" class="placeholder">–í—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ</div>
      </div>

      <div class="row">
        <button id="btnKeep" disabled>‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å (–ø—Ä–∏–º–µ—Ä)</button>
        <button id="btnDelete" disabled>üóë –£–¥–∞–ª–∏—Ç—å (–ø—Ä–∏–º–µ—Ä)</button>
      </div>

      <div class="row">
        <button id="btnTrain" disabled>üéì –û–±—É—á–∏—Ç—å</button>
        <button id="btnPredict" disabled>ü§ñ –ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å</button>
      </div>

      <div class="stats">
        <div>–ü—Ä–∏–º–µ—Ä–æ–≤ ¬´–û—Å—Ç–∞–≤–∏—Ç—å¬ª: <b id="kCount">0</b></div>
        <div>–ü—Ä–∏–º–µ—Ä–æ–≤ ¬´–£–¥–∞–ª–∏—Ç—å¬ª: <b id="dCount">0</b></div>
        <div>–°—Ç–∞—Ç—É—Å: <b id="status">–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</b></div>
        <div>–†–µ–∑—É–ª—å—Ç–∞—Ç: <b id="result">‚Äî</b></div>
      </div>

      <details>
        <summary>–°–æ–≤–µ—Ç—ã</summary>
        <ul>
          <li>–°–æ–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã <b>10‚Äì20</b> –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π –∫–ª–∞—Å—Å.</li>
          <li>–û–±—É—á–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ –º–µ—Ä–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤.</li>
          <li>–≠—Ç–æ MVP: –º—ã –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∞–≤—Ç–æ–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ.</li>
        </ul>
      </details>

      <p class="sub" style="margin-top:12px">
        –ï—Å–ª–∏ Safari —Ä—É–≥–∞–µ—Ç—Å—è –Ω–∞ ¬´–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã¬ª, –æ—Ç–∫—Ä–æ–π —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –ª—é–±–æ–π –ø—Ä–æ—Å—Ç–æ–π —Ö–æ—Å—Ç–∏–Ω–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, GitHub Pages / Netlify) ‚Äî
        —Ç–æ–≥–¥–∞ CDN-—Å–∫—Ä–∏–ø—Ç—ã –≥—Ä—É–∑—è—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ.
      </p>
    </section>
  </main>

  <!-- TF.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <!-- MobileNet -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1"></script>

  <script>
    // ========= helpers =========
    const el = (id) => document.getElementById(id);

    const fileInput = el('file');
    const imgEl = el('img');
    const placeholder = el('placeholder');

    const btnKeep = el('btnKeep');
    const btnDelete = el('btnDelete');
    const btnTrain = el('btnTrain');
    const btnPredict = el('btnPredict');
    const btnClear = el('btnClear');

    const kCountEl = el('kCount');
    const dCountEl = el('dCount');
    const statusEl = el('status');
    const resultEl = el('result');

    // ========= state =========
    let mobilenetModel = null;
    let headModel = null;              // –º–∞–ª–µ–Ω—å–∫–∏–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    let featureSize = 1024;            // –¥–ª—è mobilenet v1 alpha=1.0 –æ–±—ã—á–Ω–æ 1024 (—É—Ç–æ—á–Ω–∏–º –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Ñ–∏—á–∏)

    let X = []; // –º–∞—Å—Å–∏–≤ —Ç–µ–Ω–∑–æ—Ä–æ–≤ [featureSize]
    let Y = []; // –º–∞—Å—Å–∏–≤ –º–µ—Ç–æ–∫: 0=delete, 1=keep

    let currentFeature = null;

    function setStatus(s) { statusEl.textContent = s; }
    function setResult(s) { resultEl.textContent = s; }
    function refreshCounts() {
      const k = Y.filter(v => v === 1).length;
      const d = Y.filter(v => v === 0).length;
      kCountEl.textContent = String(k);
      dCountEl.textContent = String(d);
      btnTrain.disabled = (k < 2 || d < 2);
      btnClear.disabled = (Y.length === 0);
    }

    // ========= model setup =========
    async function loadModels() {
      setStatus('–∑–∞–≥—Ä—É–∂–∞—é MobileNet‚Ä¶');
      mobilenetModel = await mobilenet.load({ version: 1, alpha: 1.0 });

      // headModel —Å–æ–∑–¥–∞–¥–∏–º –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ —É–∑–Ω–∞–µ–º —Ç–æ—á–Ω—ã–π featureSize
      setStatus('–≥–æ—Ç–æ–≤–æ: –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ');
      fileInput.disabled = false;
    }

    function buildHeadModel(inputSize) {
      const model = tf.sequential();
      model.add(tf.layers.dense({ inputShape: [inputSize], units: 128, activation: 'relu' }));
      model.add(tf.layers.dropout({ rate: 0.2 }));
      model.add(tf.layers.dense({ units: 2, activation: 'softmax' })); // [delete, keep]
      model.compile({
        optimizer: tf.train.adam(0.001),
        loss: 'sparseCategoricalCrossentropy',
        metrics: ['accuracy'],
      });
      return model;
    }

    // ========= feature extraction =========
    function getFeatureFromImage() {
      // mobilenetModel.infer(img, true) -> embedding (Tensor)
      // –í–∞–∂–Ω–æ: imgEl –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≤–∏–¥–∏–º.
      return tf.tidy(() => {
        const emb = mobilenetModel.infer(imgEl, true);  // shape: [1, N]
        const flat = emb.squeeze();                     // [N]
        return flat.clone();                            // —Å–æ—Ö—Ä–∞–Ω–∏–º –∑–∞ tidy
      });
    }

    function enableLabelButtons(on) {
      btnKeep.disabled = !on;
      btnDelete.disabled = !on;
      btnPredict.disabled = !on;
    }

    // ========= UI events =========
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      setResult('‚Äî');
      setStatus('–∑–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ‚Ä¶');

      const url = URL.createObjectURL(file);
      imgEl.src = url;
      imgEl.style.display = 'block';
      placeholder.style.display = 'none';

      await new Promise((res, rej) => {
        imgEl.onload = () => res();
        imgEl.onerror = () => rej(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
      });

      // –∏–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∏—á–∏
      try {
        currentFeature?.dispose?.();
        currentFeature = getFeatureFromImage();
        featureSize = currentFeature.shape[0];

        if (!headModel) {
          headModel = buildHeadModel(featureSize);
        }
        enableLabelButtons(true);
        setStatus('—Ñ–æ—Ç–æ –≥–æ—Ç–æ–≤–æ: –¥–æ–±–∞–≤—å –ø—Ä–∏–º–µ—Ä –∏–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∂–∏');
      } catch (err) {
        console.error(err);
        setStatus('–æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤');
      } finally {
        URL.revokeObjectURL(url);
      }
    });

    btnKeep.addEventListener('click', () => {
      if (!currentFeature) return;
      X.push(currentFeature.clone());
      Y.push(1);
      setStatus('–¥–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä: –û—Å—Ç–∞–≤–∏—Ç—å');
      refreshCounts();
    });

    btnDelete.addEventListener('click', () => {
      if (!currentFeature) return;
      X.push(currentFeature.clone());
      Y.push(0);
      setStatus('–¥–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä: –£–¥–∞–ª–∏—Ç—å');
      refreshCounts();
    });

    btnTrain.addEventListener('click', async () => {
      if (!headModel) return;
      if (X.length < 4) return;

      setStatus('–æ–±—É—á–∞—é‚Ä¶ (–Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π –≤–∫–ª–∞–¥–∫—É)');
      setResult('‚Äî');

      // —Å–æ–±–∏—Ä–∞–µ–º –¥–∞—Ç–∞—Å–µ—Ç
      const xs = tf.stack(X);          // [N, featureSize]
      const ys = tf.tensor1d(Y, 'int32');

      try {
        // –Ω–µ–±–æ–ª—å—à–æ–µ –æ–±—É—á–µ–Ω–∏–µ
        await headModel.fit(xs, ys, {
          epochs: 15,
          batchSize: Math.min(16, X.length),
          shuffle: true,
          callbacks: {
            onEpochEnd: (epoch, logs) => {
              const acc = logs?.acc ?? logs?.accuracy ?? 0;
              setStatus(`–æ–±—É—á–∞—é‚Ä¶ —ç–ø–æ—Ö–∞ ${epoch + 1}/15, acc=${(acc*100).toFixed(1)}%`);
            }
          }
        });
        setStatus('–æ–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ');
      } catch (err) {
        console.error(err);
        setStatus('–æ—à–∏–±–∫–∞ –æ–±—É—á–µ–Ω–∏—è');
      } finally {
        xs.dispose();
        ys.dispose();
      }
    });

    btnPredict.addEventListener('click', () => {
      if (!headModel || !currentFeature) {
        setResult('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ –∏ –æ–±—É—á–∏ –º–æ–¥–µ–ª—å');
        return;
      }
      const pred = tf.tidy(() => {
        const logits = headModel.predict(currentFeature.expandDims(0)); // [1,2]
        return logits.squeeze();                                        // [2]
      });

      const probs = pred.arraySync(); // [pDelete, pKeep]
      pred.dispose();

      const pDelete = probs[0];
      const pKeep = probs[1];

      const label = (pKeep >= pDelete) ? '‚úÖ –û–°–¢–ê–í–ò–¢–¨' : 'üóë –£–î–ê–õ–ò–¢–¨';
      const conf = Math.max(pKeep, pDelete);

      setResult(`${label} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ${(conf*100).toFixed(1)}%)`);
      setStatus('–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ');
    });

    btnClear.addEventListener('click', () => {
      // –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
      X.forEach(t => t.dispose());
      X = [];
      Y = [];
      refreshCounts();
      setResult('‚Äî');
      setStatus('–¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
    });

    // init
    (async () => {
      fileInput.disabled = true;
      enableLabelButtons(false);
      btnTrain.disabled = true;
      btnClear.disabled = true;
      refreshCounts();
      await loadModels();
    })();
  </script>
</body>
</html>
